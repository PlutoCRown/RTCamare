<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebRTC ÂçïÂêëËßÜÈ¢ë‰º†Ëæì</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji", sans-serif;
        margin: 24px;
        background: #f5f5f5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 32px;
      }

      .setup-section {
        text-align: center;
        margin-bottom: 32px;
      }

      .room-input {
        margin-bottom: 24px;
      }

      .room-input label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
      }

      .room-input input {
        width: 200px;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        text-align: center;
      }

      .room-input input:focus {
        outline: none;
        border-color: #007bff;
      }

      .role-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
      }

      .role-btn {
        padding: 16px 32px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 140px;
      }

      .sender-btn {
        background: #28a745;
        color: white;
      }

      .sender-btn:hover {
        background: #218838;
      }

      .receiver-btn {
        background: #007bff;
        color: white;
      }

      .receiver-btn:hover {
        background: #0056b3;
      }

      .status-section {
        text-align: center;
        padding: 40px 20px;
        display: none;
      }

      .status-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .status-text {
        font-size: 18px;
        color: #666;
        margin-bottom: 16px;
      }

      .status-detail {
        font-size: 14px;
        color: #888;
      }

      .play-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 16px;
        display: none;
      }

      .play-btn:hover {
        background: #218838;
      }

      .video-container {
        display: none;
        text-align: center;
        margin-top: 24px;
      }

      video {
        width: 100%;
        max-width: 640px;
        background: #000;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .error {
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 12px;
        border-radius: 6px;
        margin-top: 16px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>WebRTC ËßÜÈ¢ë‰º†Ëæì</h1>

      <!-- ÂàùÂßãËÆæÁΩÆÁïåÈù¢ -->
      <div id="setupSection" class="setup-section">
        <div class="room-input">
          <label for="roomInput">ÊàøÈó¥Âè∑</label>
          <input
            type="text"
            id="roomInput"
            value="demo"
            placeholder="ËæìÂÖ•ÊàøÈó¥Âè∑"
          />
        </div>
        <div class="role-buttons">
          <button id="senderBtn" class="role-btn sender-btn">Êàê‰∏∫ÂèëÈÄÅÊñπ</button>
          <button id="receiverBtn" class="role-btn receiver-btn">
            Êàê‰∏∫Êé•Êî∂Êñπ
          </button>
        </div>
      </div>

      <!-- Áä∂ÊÄÅÊòæÁ§∫ÁïåÈù¢ -->
      <div id="statusSection" class="status-section">
        <div id="statusIcon" class="status-icon">üìπ</div>
        <div id="statusText" class="status-text">ÂáÜÂ§á‰∏≠...</div>
        <div id="statusDetail" class="status-detail"></div>
        <button id="playBtn" class="play-btn">ÁÇπÂáªÊí≠ÊîæËßÜÈ¢ë</button>
        <div id="errorMsg" class="error"></div>
      </div>

      <!-- ËßÜÈ¢ëÊòæÁ§∫ÁïåÈù¢ -->
      <div id="videoContainer" class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <script>
      let ws;
      let pc;
      let localStream;
      let currentRole = null;
      let currentRoom = null;

      const setupSection = document.getElementById("setupSection");
      const statusSection = document.getElementById("statusSection");
      const videoContainer = document.getElementById("videoContainer");
      const roomInput = document.getElementById("roomInput");
      const senderBtn = document.getElementById("senderBtn");
      const receiverBtn = document.getElementById("receiverBtn");
      const statusIcon = document.getElementById("statusIcon");
      const statusText = document.getElementById("statusText");
      const statusDetail = document.getElementById("statusDetail");
      const playBtn = document.getElementById("playBtn");
      const errorMsg = document.getElementById("errorMsg");
      const remoteVideo = document.getElementById("remoteVideo");

      function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = "block";
      }

      function hideError() {
        errorMsg.style.display = "none";
      }

      function updateStatus(icon, text, detail = "") {
        statusIcon.textContent = icon;
        statusText.textContent = text;
        statusDetail.textContent = detail;
      }

      function showStatus() {
        setupSection.style.display = "none";
        statusSection.style.display = "block";
      }

      function showVideo() {
        videoContainer.style.display = "block";
        playBtn.style.display = "none";
      }

      async function createPeerConnection() {
        let iceServers = [];
        try {
          const res = await fetch("/config", { credentials: "same-origin" });
          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data.iceServers)) iceServers = data.iceServers;
          }
        } catch (_) {}

        const _pc = new RTCPeerConnection({ iceServers });

        _pc.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(
              JSON.stringify({ type: "ice-candidate", candidate: e.candidate })
            );
          }
        };

        _pc.ontrack = (e) => {
          if (!remoteVideo.srcObject) {
            remoteVideo.srcObject = e.streams[0];
            playBtn.style.display = "inline-block";
            updateStatus("üé•", "ËßÜÈ¢ëÂ∑≤Â∞±Áª™", "ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßãÊí≠Êîæ");
          }
        };

        _pc.oniceconnectionstatechange = () => {
          if (_pc.iceConnectionState === "connected") {
            if (currentRole === "sender") {
              updateStatus("üì°", "Ê≠£Âú®Êé®ÊµÅ", `ÊàøÈó¥: ${currentRoom}`);
            }
          }
        };

        return _pc;
      }

      async function startSender() {
        try {
          updateStatus("üìπ", "Ê≠£Âú®Áî≥ËØ∑ÊëÑÂÉèÂ§¥ÊùÉÈôê...", "");
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });

          pc = await createPeerConnection();
          localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));

          updateStatus("üì°", "Ê≠£Âú®ÂêëÊàøÈó¥Êé®ÊµÅ", `ÊàøÈó¥: ${currentRoom}`);
        } catch (err) {
          showError("Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥: " + err.message);
        }
      }

      async function startReceiver() {
        pc = await createPeerConnection();
        updateStatus("‚è≥", "Á≠âÂæÖÂèëÈÄÅÊñπ", `ÊàøÈó¥: ${currentRoom}`);
      }

      async function makeAndSendOffer() {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", sdp: offer }));
      }

      function connectWebSocket() {
        const httpProto = location.protocol === "https:" ? "wss" : "ws";
        ws = new WebSocket(`${httpProto}://${location.host}/ws`);

        ws.addEventListener("open", async () => {
          ws.send(
            JSON.stringify({
              type: "join",
              role: currentRole,
              room: currentRoom,
            })
          );

          if (currentRole === "sender") {
            await startSender();
          } else {
            await startReceiver();
            ws.send(JSON.stringify({ type: "ready" }));
          }
        });

        ws.addEventListener("message", async (ev) => {
          const msg = JSON.parse(ev.data);

          if (msg.type === "viewer-ready" && currentRole === "sender") {
            await makeAndSendOffer();
          }

          if (msg.type === "offer" && currentRole === "receiver") {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", sdp: answer }));
          }

          if (msg.type === "answer" && currentRole === "sender") {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
          }

          if (msg.type === "ice-candidate") {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            } catch (e) {
              console.error("addIceCandidate error", e);
            }
          }

          if (msg.type === "sender-left" && currentRole === "receiver") {
            updateStatus("‚ùå", "ÂèëÈÄÅÊñπÂ∑≤Á¶ªÂºÄ", "ËØ∑Á≠âÂæÖÊñ∞ÁöÑÂèëÈÄÅÊñπÂä†ÂÖ•");
            playBtn.style.display = "none";
            videoContainer.style.display = "none";
          }

          if (msg.type === "viewer-left" && currentRole === "sender") {
            updateStatus("üì°", "Á≠âÂæÖÊé•Êî∂Êñπ", `ÊàøÈó¥: ${currentRoom}`);
          }

          if (msg.type === "error") {
            showError("ËøûÊé•ÈîôËØØ: " + msg.reason);
          }
        });

        ws.addEventListener("error", () => {
          showError("WebSocket ËøûÊé•Â§±Ë¥•");
        });
      }

      playBtn.addEventListener("click", async () => {
        try {
          await remoteVideo.play();
          showVideo();
          updateStatus("üé•", "Ê≠£Âú®Êí≠Êîæ", `ÊàøÈó¥: ${currentRoom}`);
        } catch (err) {
          showError("Êí≠ÊîæÂ§±Ë¥•: " + err.message);
        }
      });

      senderBtn.addEventListener("click", () => {
        currentRole = "sender";
        currentRoom = roomInput.value.trim() || "demo";
        showStatus();
        hideError();
        connectWebSocket();
      });

      receiverBtn.addEventListener("click", () => {
        currentRole = "receiver";
        currentRoom = roomInput.value.trim() || "demo";
        showStatus();
        hideError();
        connectWebSocket();
      });
    </script>
  </body>
</html>
